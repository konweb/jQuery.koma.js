"use strict";!function(){function t(t,i){this.option=$.extend({fps:20,steps:[],itemEl:".koma-items",restartEl:".koma-restart",stopEl:".koma-stop"},i),this.$el=t,this.$img=this.$el.find(this.option.itemEl+" img"),this.$item=this.$el.find(this.option.itemEl),this.$restart=this.$el.find(this.option.restartEl),this.$stop=this.$el.find(this.option.stopEl),this.imgLen=this.$img.length,this.startTime=n(),this.animationFlag=!0,this.isSteps=this.option.steps.length>0?!0:!1,this.setup()}var i=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),e=window.performance&&(performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow),n=function(){return e&&e.call(performance)||(new Date).getTime()},o=!0;t.prototype.setup=function(){var t=this;this.$img.slice(1).hide(),this.imgLoad().then(function(){t.animation(),t.eventify(),t.isSteps&&t.imgLoadSteps()}).fail(function(){console.log("image load error")})},t.prototype.eventify=function(){var t=this,e=new $.Event("koma_stop"),n=new $.Event("koma_restart");this.$stop.on("click",function(){window.cancelAnimationFrame?window.cancelAnimationFrame(t.requestId):o=!1,t.$el.trigger(e,{$el:t.$el})}),this.$restart.on("click",function(){o=!0,t.requestId=i($.proxy(t.animation,t)),t.$el.trigger(n,{$el:t.$el})})},t.prototype.imgLoad=function(){var t=this,i=arguments.length<=0||void 0===arguments[0]?0:arguments[0],e=arguments.length<=1||void 0===arguments[1]?this.isSteps?this.option.steps[0]:this.imgLen:arguments[1],n=[],o=$.Deferred();this.imgLen=this.isSteps?this.option.steps[0]:this.imgLen;for(var s=function(i){var e=new Image,o=$.Deferred();e.onload=function(){o.resolve()},e.error=function(){o.reject()},e.src=t.$img.eq(i).attr("src"),n.push(o)},r=i;e>r;r++)s(r);return $.when.apply(null,n).done(function(){o.resolve()}).fail(function(){o.reject()}),o.promise()},t.prototype.imgLoadSteps=function(){for(var t=this,i=this.option.steps,e=i.length,n=$.Deferred().resolve(),o=0,s=i[0],r=function(e){n=n.then(function(){return o=s+i[e],t.imgLoad(s,o)}).then(function(){s=o,t.imgLen=o}).fail(function(){console.log("image load error")})},a=1;e>a;a++)r(a)},t.prototype.animation=function(){if(o){this.requestId=i($.proxy(this.animation,this));var t=n(),e=Math.floor((t-this.startTime)/(1e3/this.option.fps)%this.imgLen);0===e&&(e=1),this.$img.hide().slice(e-1,e).show()}},$.fn.koma=function(i){var e=this;return this.each(function(){new t($(e),i)})}}();